本章利用第二章基于`rdd`的模型处理也许是最让人吃惊的领域-大规模流式处理。虽然最终的设计和传统的流式数据处理系统不一样，但是它提供了丰富的故障恢复能力以及强大的和其他处理类型相兼容的能力。

大规模流式处理的动机很简单：大量的“大数据”在某一时间被接收，并且这些被接收的数据在到达的那刻价值最大。例如，一个社交网络可能希望探测几分钟之内的热门话题；一个搜索网站可能建模哪个用户
访问一个新的页；一个服务操作者可能希望监控程序日志，用于探测几秒内发生的错误。为了使用这些应用，有必要将流式处理模型扩展大更大的集群上面。

然而设计这样一个模型具有挑战性，因为对于可以扩展到几百个节点的更大的应用（如实时日志处理或者机器学习），扩展是必要的。在这样的扩展中，错误和掉队(`stragglers`)是一个重要问题【36】,一般
情况下，流式应用需要快速恢复。事实上，快速恢复在流式处理任务中比在批处理任务中更重要，在批处理设置中，一个30秒的从错误或`stragglers`中恢复的延迟是非常令人讨厌的（言外之意是可以接受）；而在流式处理中，30可能意味着
我们失去了做一个关键决策的机会。

不幸的是，现存的流式处理系统在容错方面存在限制。大部分的分布式流式系统，包括`storm`【14】,`TimeStream`【87】,`MapReduce Online`【34】以及流式数据库【18,26,29】都是基于连续的操作模型。这个模型长时间
运行，有状态的操作程序接收每条记录，更新记录的内部状态，然后发送新的记录。虽然这个模型设计很自然，但是它很难处理容错。

特别的，给定连续操作模型（`continuous operator model`），系统通过两种方式完成恢复：复制（每个节点有两份数据【18,93】）或向上回退（节点缓存发送的消息，然后重新发送它们到失败的节点【87，34,14】），
在大规模集群中，这两种方法都不好。复制会花费两倍的硬盘空间；回退会花费很长的时间去恢复，因为整个系统必须等待一个新的节点有序的重建错误节点的状态，重新运行数据。另外，这两种方法都不处理`stragglers`
数据，在向上回退系统中，将`stragglers`视为失败，这会造成昂贵的恢复过程发生；在复制系统中，它们利用同步协议（如`Flux`【93】）去协调复制数据，所以`stragglers`在两份复制中会变慢。

我们提出了一个新的流式处理模型，离散化流式处理（`D-Streams`），它克服了上面的挑战。不是管理长时间在线的算子，`DStreams`流结构计算小时间范围内的一系列无状态的、确定的批算子。例如，我们可能放置
每秒（或者每100毫秒）的数据到一个区间，然后在每一个区间运行一个MapReduce操作去运行一个计数。同样的，我们可以运行一个跨过多个区间的滚动计数，它通过从每个新的区间中拿计数添加到旧的结果中。通过
结构化计算这种方式，`D-Streams`使state在每个时间步完全确定性的给定输入数据，放弃同步协议以及state和老数据在细粒度上的依赖。这大大加强了恢复机制。

实现`D-Stream`模型有两个挑战。第一个挑战是使延迟（区间粒度）低。传统的批处理系统，例如`Hadoop`，无法做到这样，因为它们保存状态到副本中-基于磁盘的存储系统。取而代之的是，我们构造了RDD数据结构，
它保存数据在内存中，可以不通过副本恢复，而是通过跟踪血统（`lineage`）图操作构建。使用RDD，我们可以实现端到端的延迟到1秒。我们相信这满足大部分现实世界的大数据应用，事件跟踪的时间范围比这要高的多。

第二个挑战是从错误和`stragglers`恢复的速度。我们使用`D-Streams`的确定性提供了一个新的恢复机制-并行恢复，它在之前的流处理系统中没有出现过。当一个节点失败，集群中的每个节点都会重新计算失败节点的
部分rdd，这会比向上回退快很多并且不需要副本。并行恢复在连续处理系统中很难执行，因为复杂的状态同步协议需要基本的副本，但是这在完全确定的`D-Stream`模型中很简单。利用相同的方法，`D-Streams`可以使用
推测执行【36】（`speculative execution`）从`stragglers`中恢复，而之前的系统无法做到。

我们在Spark Streaming系统中实现了`D-Streams`。这个系统可以在100个节点上以亚秒的延迟每秒处理6000万条数据，并且可以在亚秒时间内恢复错误和`stragglers`。`Spark Streaming`每个节点的吞吐量比得上商业
的流数据库，而扩展到100个节点，其速度是开源的`Storm`和S4系统的2-5倍，并且提供它们缺乏的容错保证。

除了它的性能，我们通过两个真实的系统-分布式视频监控系统、在线机器学习系统，来描述`Spark Streaming`的表现力（`expressiveness`）。

最后，因为`D-Streams`使用相同的处理模型和数据结构（`RDD`）作为批作业，我们的模型的一个很大的优势是流处理可以完美的演化为批计算和交互式计算。我们在`Spark Streaming`使用这个特征让用户在`spark`流中运行
`ad-hoc`查询或者联合流和历史数据为一个`RDD`用于计算。在实际情况中，这是一个强大的特征，给用户一个简单的API，就可以联合之前不同的计算。我们将描述怎样在我们的系统中使用它来模糊实时和离线处理的界限。

